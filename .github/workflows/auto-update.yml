name: Auto-update
on:
  push:
    branches:
      - "ulrikstrid/auto-update"
jobs:
  update-sources:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: cachix/install-nix-action@v16
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable
      - name: "Update sources"
        uses: actions/github-script@v5
        id: update-sources
        with:
          result-encoding: string
          script: |
            const script = require('./.github/workflows/auto-update.js')
            return await script({github, context, core, require})
      - name: "format sources.nix"
        run: |
          find . -iname '*.nix' | xargs nix shell -f ./boot.nix nixpkgs-fmt -c nixpkgs-fmt ./sources.nix
      - name: Print diff url
        run: echo "${{steps.update-sources.outputs.result}}"
