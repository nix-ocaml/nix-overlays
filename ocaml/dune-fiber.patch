From ce4a9d7c55204c9e560b4d066bc07e3389056b52 Mon Sep 17 00:00:00 2001
From: Antonio Nuno Monteiro <anmonteiro@gmail.com>
Date: Sat, 18 Feb 2023 14:21:16 -0800
Subject: [PATCH] Revert "remove fiber from public libraries (#6925)"

This reverts commit 3120c2e3adc9269d992ad21a68dfd952c4417995.
---
 dune-project                  |  9 +++++++++
 fiber.opam                    | 34 ++++++++++++++++++++++++++++++++++
 otherlibs/fiber/src/dune      |  1 +
 otherlibs/fiber/src/fiber.mli |  5 +++++
 4 files changed, 49 insertions(+)
 create mode 100644 fiber.opam

diff --git a/dune-project b/dune-project
index 83575cbd7f..a0eb608d7c 100644
--- a/dune-project
+++ b/dune-project
@@ -202,6 +202,15 @@ understood by dune language."))
   (dyn (= :version)))
  (description "This library offers no backwards compatibility guarantees. Use at your own risk."))
 
+(package
+ (name fiber)
+ (synopsis "Structured concurrency library")
+ (depends
+  (ocaml (>= 4.08.0))
+  (stdune (= :version))
+  (dyn (= :version)))
+ (description "This library offers no backwards compatibility guarantees. Use at your own risk."))
+
 (package
  (name chrome-trace)
  (synopsis "Chrome trace event generation library")
diff --git a/fiber.opam b/fiber.opam
new file mode 100644
index 0000000000..215d8ddcd9
--- /dev/null
+++ b/fiber.opam
@@ -0,0 +1,34 @@
+# This file is generated by dune, edit dune-project instead
+opam-version: "2.0"
+synopsis: "Structured concurrency library"
+description:
+  "This library offers no backwards compatibility guarantees. Use at your own risk."
+maintainer: ["Jane Street Group, LLC <opensource@janestreet.com>"]
+authors: ["Jane Street Group, LLC <opensource@janestreet.com>"]
+license: "MIT"
+homepage: "https://github.com/ocaml/dune"
+doc: "https://dune.readthedocs.io/"
+bug-reports: "https://github.com/ocaml/dune/issues"
+depends: [
+  "dune" {>= "3.5"}
+  "ocaml" {>= "4.08.0"}
+  "stdune" {= version}
+  "dyn" {= version}
+  "odoc" {with-doc}
+]
+dev-repo: "git+https://github.com/ocaml/dune.git"
+build: [
+  ["dune" "subst"] {dev}
+  ["rm" "-rf" "vendor/csexp"]
+  ["rm" "-rf" "vendor/pp"]
+  [
+    "dune"
+    "build"
+    "-p"
+    name
+    "-j"
+    jobs
+    "@install"
+    "@doc" {with-doc}
+  ]
+]
diff --git a/otherlibs/fiber/src/dune b/otherlibs/fiber/src/dune
index d9ebf17845..43cf8edc10 100644
--- a/otherlibs/fiber/src/dune
+++ b/otherlibs/fiber/src/dune
@@ -1,5 +1,6 @@
 (library
  (name fiber)
+ (public_name fiber)
  (libraries stdune dyn)
  (synopsis "Monadic concurrency library")
  (instrumentation
diff --git a/otherlibs/fiber/src/fiber.mli b/otherlibs/fiber/src/fiber.mli
index aa5e8fec54..72f57b99d6 100644
--- a/otherlibs/fiber/src/fiber.mli
+++ b/otherlibs/fiber/src/fiber.mli
@@ -1,3 +1,8 @@
+[@@@alert
+unstable "The API of this library is not stable and may change without notice."]
+
+[@@@alert "-unstable"]
+
 (** Concurrency library
 
     This module implements
